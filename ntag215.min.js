let f=require("Storage"),g=!1,k,l,m=[],n;
class p{constructor(){var b=r(0);t(this,b);this.l=this.i=this.o=!1;this.s=[];this.g=0;this.j=this.h;let a=this;NRF.on("NFCon",function(){u(a.g)});NRF.on("NFCoff",function(){v();a.o=!1;a.i=!1;a.j=a.h;let c=[0,1];for(let d=0;8>d;d++)if(a._data[11]&1<<d&&c.push(d+8),a._data[10]&1<<d)switch(d){case 0:case 1:case 2:case 3:break;default:c.push(d+4)}a.o||(a._data[520]&1&&c.push(16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31),a._data[520]&1&&c.push(32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47),a._data[520]&
1&&c.push(48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63),a._data[520]&1&&c.push(64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79),a._data[520]&1&&c.push(80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95),a._data[520]&1&&c.push(96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111),a._data[520]&1&&c.push(112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127),a._data[520]&1&&c.push(128,129));this.s=c;1==a.l&&(console.log("Saving tag to flash"),w(a.g,a._data),a.l=!1);x(a)&&(NRF.nfcStop(),
NRF.nfcStart(new Uint8Array([a._data[0],a._data[1],a._data[2],a._data[4],a._data[5],a._data[6],a._data[7]])))});NRF.on("NFCrx",function(c){if(c&&a.j[c[0]])a.j[c[0]](c,a);else NRF.nfcSend(0)})}}function t(b,a){NRF.nfcStop();b._data=a||new Uint8Array(572);x(b);a=NRF.nfcStart(new Uint8Array([a[0],a[1],a[2],a[4],a[5],a[6],a[7]]));b._data.set(a,0)}
function x(b){let a=b._data[0]^b._data[1]^b._data[2]^136,c=b._data[4]^b._data[5]^b._data[6]^b._data[7];return b._data[3]!=a||b._data[8]!=c?(b._data[3]=a,b._data[8]=c,console.log("Fixed bad bcc"),!0):!1}
p.prototype={m:{version:new Uint8Array([0,4,4,2,1,0,17,3]),v:new Uint8Array([128,128]),u:new Uint8Array([1,2,3,4,5,6,7,8])},h:{type:function(){return"normal"},48:function(b,a){2>b.length?NRF.nfcSend(0):NRF.nfcSend(new Uint8Array(a._data.buffer,4*b[1],16))},162:function(b,a){if(!a.i&&(0>b[1]||134<b[1]||-1!=a.s.indexOf(b[1])))NRF.nfcSend(0);else{if(!a.i){if(2==b[1]){NRF.nfcSend(10);a._data[10]|=b[4];a._data[11]|=b[5];return}if(3==b[1]){NRF.nfcSend(10);a._data[16]|=b[2];a._data[17]|=b[3];a._data[18]|=
b[4];a._data[19]|=b[5];return}}var c=4*b[1];c>a._data.length?NRF.nfcSend(0):(NRF.nfcSend(10),a._data.set(new Uint8Array(b,2,4),c));a.l=!0}},96:function(b,a){NRF.nfcSend(a.m.version)},58:function(b,a){b[1]>b[2]||0>b[1]||134<b[2]?(NRF.nfcSend(0),console.log("Invalid fast read command")):133==b[1]&&134==b[2]?(NRF.nfcSend(a.m.u),a.i=!0,a.j=a._unrestrictedCallbacks):NRF.nfcSend(new Uint8Array(a._data.buffer,4*b[1],4*(b[2]-b[1]+1)))},27:function(b,a){NRF.nfcSend(a.m.v);a.o=!0},60:function(b,a){NRF.nfcSend(new Uint8Array(a._data.buffer,
540,32))},136:function(){NRF.nfcSend(10)},26:function(){NRF.nfcSend()},147:function(){NRF.nfcSend()}}};p.prototype._unrestrictedCallbacks={type:function(){return"unrestricted"},48:p.prototype.h[48],162:function(b,a){NRF.nfcSend(10);a._data.set(new Uint8Array(b,2,4),4*b[1]);a.l=!0},96:p.prototype.h[96],58:p.prototype.h[58],27:p.prototype.h[27],60:p.prototype.h[60],136:p.prototype.h[136],26:p.prototype.h[26],147:p.prototype.h[147]};
function r(b){b="tag"+b+".bin";let a=y(f.readArrayBuffer(b));console.log("Read "+b);return a}function w(b,a){m[b]=new Uint8Array(80);m[b].set(a.slice(0,8),0);m[b].set(a.slice(16,24),8);m[b].set(a.slice(32,52),20);m[b].set(a.slice(84,92),40);m[b].set(a.slice(96,128),48);b="tag"+b+".bin";f.write(b,a);console.log("Saved "+b)}function z(){for(let b=0;7>b;b++){let a=new Uint8Array(572),c=r(b);c?a=c:(a[3]=136,a.set([72,0,0,225,16,62,0,3,0,254],9),a.set([189,4,0,0,255,0,5],523));w(b,a)}k=new p;k.g=0}
function y(b){if(b){let a=new Uint8Array(b.length);for(let c=0;c<b.length;c++)a[c]=b[c];return a}}function A(){NRF.setServices({},{uart:!0});g=!1;v(1,1,1);setWatch(function(){g=!0;LED1.write(0);LED2.write(0)},BTN,{repeat:!1,edge:"rising",debounce:50});setTimeout(B,5E3)}function C(b,a,c,d){1>c?d&&d():(b.write(1),setTimeout(function(){b.write(0);setTimeout(function(){C(b,a,c-1,d)},a)},a))}
function D(){setWatch(function(){C(LED2,150,2,function(){NRF.wake();A()})},BTN,{repeat:!1,edge:"rising",debounce:5E3})}function v(b,a,c){a=a?a:0;c=c?c:0;LED1.write(b?b:0);LED2.write(a);LED3.write(c)}function u(b){7>b&&(b+=1,v(b&1,b&2,b&4))}
function B(){v();clearWatch();z();let b=null;n=function(a){b&&(clearTimeout(b),b=null);NRF.nfcStop();u(a);b=setTimeout(function(c){v();let d=r(c);t(k,d);k.g=c;b=null},200,a)};setWatch(function(){clearWatch();D();NRF.sleep();NRF.nfcStop();C(LED1,150,2)},BTN,{repeat:!1,edge:"rising",debounce:5E3});setWatch(function(){n(7<=++k.g?0:k.g)},BTN,{repeat:!0,edge:"falling",debounce:50});NRF.setAdvertising({},{name:y(f.readArrayBuffer("puck-name"))});if(!g){let a={"78290001-d52e-473f-a9f4-f03da7c67dd1":{}};
a["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"]={maxLen:260,value:[],readable:!0,writable:!1,indicate:!1};a["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290002-d52e-473f-a9f4-f03da7c67dd1"]={maxLen:20,value:[],readable:!0,writable:!0,indicate:!1,onWrite:function(c){if(0<c.data.length){let d={"78290001-d52e-473f-a9f4-f03da7c67dd1":{}};d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290002-d52e-473f-a9f4-f03da7c67dd1"]={value:c.data,indicate:!1};d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"]=
{value:[],indicate:!1};switch(c.data[0]){case 1:(function(){if(1<c.data.length){let e=7>c.data[1]?c.data[1]:k.g,h=m[e];d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value=new Uint8Array(h.length+2);d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value.set(new Uint8Array(c.data,0,2),0);d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value[1]=e;d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value.set(h,
2)}else d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value=[1,k.g,7];NRF.updateServices(d)})();break;case 2:(function(){var e=4*c.data[2];let h=4*c.data[3],q=7>c.data[1]?c.data[1]:k.g;e=r(q).slice(e,e+h);d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value=new Uint8Array(h+4);d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value.set(new Uint8Array(c.data,0,4),0);d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value[1]=
q;d["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290003-d52e-473f-a9f4-f03da7c67dd1"].value.set(e,4);NRF.updateServices(d)})();break;case 3:(function(){let e=4*c.data[2],h=c.data.length-3,q=7>c.data[1]?c.data[1]:k.g;0==c.data[2]&&(l=r(q));572>=e+h&&l.set(new Uint8Array(c.data,3,h),e);140==c.data[2]&&w(q,l)})();break;case 253:(function(){var e=c.data[1];let h=c.data[2];7>e&&7>h&&(e=r(e),w(h,e),n(k.g))})();break;case 254:NRF.setServices({},{uart:!0});break;case 255:1<c.data.length?n(7<=c.data[1]?0:c.data[1]):
n(k.g)}}}};a["78290001-d52e-473f-a9f4-f03da7c67dd1"]["78290004-d52e-473f-a9f4-f03da7c67dd1"]={maxLen:20,value:y(f.readArrayBuffer("puck-name")),readable:!0,writable:!0,indicate:!1,onWrite:function(c){0<c.data.length?f.write("puck-name",c.data):f.erase("puck-name");NRF.setAdvertising({},{name:y(f.readArrayBuffer("puck-name"))})}};NRF.setServices(a,{uart:!1,advertise:["78290001-d52e-473f-a9f4-f03da7c67dd1"]})}}A();
